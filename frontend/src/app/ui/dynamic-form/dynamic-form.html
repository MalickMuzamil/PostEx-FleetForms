<nz-card [nzTitle]="config.title">
  <form [formGroup]="form" (ngSubmit)="submit()">

    <div class="form-grid">
      <ng-container *ngFor="let field of config.fields">

        <!-- TEXT -->
        <nz-form-item *ngIf="field.type === 'text'">
          <nz-form-label [nzRequired]="field.required">
            {{ field.label }}
          </nz-form-label>
          <nz-form-control>
            <input
              nz-input
              [type]="field.key === 'email' ? 'email' : 'text'"
              [formControlName]="field.key"
              [disabled]="!!field.disabled"
              [attr.maxlength]="field.key === 'email' ? 50 : null"
            />
            <div class="text-danger mt-1" *ngIf="hasError(field.key, 'required')">
              {{ field.label }} is required
            </div>
          </nz-form-control>
        </nz-form-item>

        <!-- NUMBER -->
        <nz-form-item *ngIf="field.type === 'number'">
          <nz-form-label [nzRequired]="field.required">
            {{ field.label }}
          </nz-form-label>
          <nz-form-control>
            <input
              nz-input
              type="number"
              [formControlName]="field.key"
              [disabled]="!!field.disabled"
            />
          </nz-form-control>
        </nz-form-item>

        <!-- TEXTAREA -->
        <nz-form-item *ngIf="field.type === 'textarea'">
          <nz-form-label [nzRequired]="field.required">
            {{ field.label }}
          </nz-form-label>
          <nz-form-control>
            <textarea
              nz-input
              rows="3"
              [formControlName]="field.key"
              [disabled]="!!field.disabled"
            ></textarea>
          </nz-form-control>
        </nz-form-item>

        <!-- ✅ SELECT (CLEAN – NO DROPDOWN LOADER) -->
        <nz-form-item *ngIf="field.type === 'select'">
          <nz-form-label [nzRequired]="field.required">
            {{ field.label }}
          </nz-form-label>

          <nz-form-control>
            <nz-select
              nzAllowClear
              nzShowSearch
              [nzFilterOption]="filterOption"
              [formControlName]="field.key"
              [nzDisabled]="field.disabled"
              [nzLoading]="!!field.loading"
              nzNotFoundContent="No data"
              (nzSearchValueChange)="onSelectSearch(field.key, $any($event))"
              (ngModelChange)="onSelectChange(field.key, $event)"
            >

              <!-- HEADER (optional column header) -->
              <nz-option
                *ngIf="field.optionColumns?.length"
                nzDisabled="true"
                nzCustomContent="true"
                [nzLabel]="'__header__'"
                [nzValue]="null"
              >
                <div class="opt-row opt-header">
                  <div
                    class="opt-cell"
                    *ngFor="let c of field.optionColumns"
                    [style.width]="c.width || 'auto'"
                  >
                    {{ c.title }}
                  </div>
                </div>
              </nz-option>

              <!-- ASYNC OPTIONS -->
              <ng-container *ngIf="field.options$; else staticOptions">
                <nz-option
                  *ngFor="let opt of (field.options$ | async) || []"
                  [nzLabel]="opt.label"
                  [nzValue]="opt.value"
                  [nzTitle]="opt.searchText || opt.label"
                  nzCustomContent="true"
                >
                  <ng-container *ngIf="field.optionColumns?.length; else simpleOpt">
                    <div class="opt-row">
                      <div
                        class="opt-cell"
                        *ngFor="let c of field.optionColumns"
                        [style.width]="c.width || 'auto'"
                      >
                        {{ opt.meta?.[c.key] ?? '' }}
                      </div>
                    </div>
                  </ng-container>
                  <ng-template #simpleOpt>{{ opt.label }}</ng-template>
                </nz-option>
              </ng-container>

              <!-- STATIC OPTIONS -->
              <ng-template #staticOptions>
                <nz-option
                  *ngFor="let opt of field.options || []"
                  [nzLabel]="opt.label"
                  [nzValue]="opt.value"
                  [nzTitle]="opt.searchText || opt.label"
                >
                  {{ opt.label }}
                </nz-option>
              </ng-template>

            </nz-select>

            <div class="text-danger mt-1" *ngIf="hasError(field.key, 'required')">
              {{ field.label }} is required
            </div>
          </nz-form-control>
        </nz-form-item>

        <!-- DATE -->
        <nz-form-item *ngIf="field.type === 'date'">
          <nz-form-label [nzRequired]="field.required">
            {{ field.label }}
          </nz-form-label>
          <nz-form-control>
            <nz-date-picker
              style="width: 100%"
              [formControlName]="field.key"
              [nzDisabled]="field.disabled"
              [nzDisabledDate]="getDisabledDateFn(field.key)"
              [nzInputReadOnly]="true"
            ></nz-date-picker>
          </nz-form-control>
        </nz-form-item>

        <!-- CHECKBOX -->
        <nz-form-item *ngIf="field.type === 'checkbox'">
          <nz-form-label [nzRequired]="field.required">
            {{ field.label }}
          </nz-form-label>
          <nz-form-control>
            <label nz-checkbox [formControlName]="field.key">
              {{ field.label }}
            </label>
          </nz-form-control>
        </nz-form-item>

      </ng-container>
    </div>

    <div class="form-actions mt-3">
      <button nz-button nzType="primary" [disabled]="form.invalid">
        Save
      </button>
    </div>

  </form>
</nz-card>
