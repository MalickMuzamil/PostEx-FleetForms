<nz-card [nzTitle]="config.title">
  <form [formGroup]="form" (ngSubmit)="submit()">
    <div class="form-grid">
      <ng-container *ngFor="let field of config.fields">

        <!-- TEXT -->
        <nz-form-item *ngIf="field.type === 'text'">
          <nz-form-label [nzRequired]="field.required">
            {{ field.label }}
          </nz-form-label>

          <nz-form-control>
            <!-- Default input (all existing forms) -->
            <ng-container
              *ngIf="field.mask !== 'SHORT_CODE_3_2' && field.mask !== 'ALPHA5_ROMAN' && field.mask !== 'AAA_AAA'; else maskedInput">
              <input nz-input [type]="field.key === 'email' ? 'email' : 'text'" [formControlName]="field.key"
                [disabled]="!!field.disabled" [attr.maxlength]="field.key === 'email' ? 50 : null" autocomplete="off"
                spellcheck="false" />
            </ng-container>

            <!--  Masked input -->
            <ng-template #maskedInput>

              <!-- SHORT_CODE_3_2 -->
              <ng-container *ngIf="field.mask === 'SHORT_CODE_3_2'; else alpha5RomanInput">
                <input nz-input type="text" [formControlName]="field.key" [disabled]="!!field.disabled" maxlength="6"
                  autocomplete="off" spellcheck="false" [appShortCodeMask]="'SHORT_CODE_3_2'" />
              </ng-container>

              <!-- ALPHA5_ROMAN -->
              <ng-template #alpha5RomanInput>
                <ng-container *ngIf="field.mask === 'ALPHA5_ROMAN'; else aaaAaaInput">
                  <input nz-input type="text" [formControlName]="field.key" [disabled]="!!field.disabled" maxlength="10"
                    autocomplete="off" spellcheck="false" [appShortCodeMask]="'ALPHA5_ROMAN'" />
                </ng-container>
              </ng-template>

              <!-- AAA_AAA -->
              <ng-template #aaaAaaInput>
                <input nz-input type="text" [formControlName]="field.key" [disabled]="!!field.disabled" maxlength="7"
                  autocomplete="off" spellcheck="false" [appShortCodeMask]="'AAA_AAA'" />
              </ng-template>

            </ng-template>

            <!-- REQUIRED -->
            <div class="text-danger mt-1" *ngIf="hasError(field.key, 'required')">
              {{ field.label }} is required
            </div>

            <!-- SHORT_CODE_3_2 FORMAT -->
            <div class="text-danger mt-1" *ngIf="field.mask === 'SHORT_CODE_3_2' && hasError(field.key, 'invalidName')">
              Name must be in format <b>HHH-HH</b> (letters only)
            </div>

            <!-- ALPHA5_ROMAN FORMAT -->
            <div class="text-danger mt-1" *ngIf="field.mask === 'ALPHA5_ROMAN' && hasError(field.key, 'invalidName')">
              Name must be in format <b>AAAAA-II</b> (5 letters + - + Roman)
            </div>

            <!-- AAA_AAA FORMAT -->
            <div class="text-danger mt-1" *ngIf="field.mask === 'AAA_AAA' && hasError(field.key, 'invalidName')">
              Name must be in format <b>AAA-AAA</b> (letters only)
            </div>

            <!-- EMAIL FORMAT (Angular built-in key) -->
            <div class="text-danger mt-1" *ngIf="field.key === 'email' && hasError(field.key, 'email')">
              Please enter a valid email address
            </div>

            <!-- EMAIL FORMAT (common custom key fallback) -->
            <div class="text-danger mt-1" *ngIf="field.key === 'email' && hasError(field.key, 'invalidEmail')">
              Please enter a valid email address
            </div>

            <!-- MAX LENGTH -->
            <div class="text-danger mt-1" *ngIf="field.key === 'email' && hasError(field.key, 'maxlength')">
              Maximum 50 characters allowed
            </div>
          </nz-form-control>
        </nz-form-item>

        <!-- NUMBER -->
        <nz-form-item *ngIf="field.type === 'number'">
          <nz-form-label [nzRequired]="field.required">
            {{ field.label }}
          </nz-form-label>

          <nz-form-control>
            <input nz-input type="number" [formControlName]="field.key" [disabled]="!!field.disabled" />
          </nz-form-control>
        </nz-form-item>

        <!-- TEXTAREA -->
        <nz-form-item *ngIf="field.type === 'textarea'">
          <nz-form-label [nzRequired]="field.required">
            {{ field.label }}
          </nz-form-label>

          <nz-form-control>
            <textarea nz-input rows="3" [formControlName]="field.key" [disabled]="!!field.disabled" autocomplete="off"
              spellcheck="false"></textarea>
          </nz-form-control>
        </nz-form-item>

        <!-- SELECT -->
        <nz-form-item *ngIf="field.type === 'select'">
          <nz-form-label [nzRequired]="field.required">
            {{ field.label }}
          </nz-form-label>

          <nz-form-control>
            <nz-select nzAllowClear [nzShowSearch]="!!field.searchable" [nzFilterOption]="filterOption"
              [formControlName]="field.key" [nzDisabled]="!!field.disabled" [nzLoading]="!!field.loading"
              nzNotFoundContent="No data" nzDropdownClassName="opt-dropdown"
              (nzValueChange)="onSelectChange(field.key, $event)"
              (nzSearchValueChange)="onSelectSearch(field.key, $any($event))">
              <!-- HEADER (optional column header) -->
              <nz-option *ngIf="field.optionColumns?.length" [nzDisabled]="true" [nzCustomContent]="true"
                [nzLabel]="'__header__'" [nzValue]="null">
                <div class="opt-row opt-header" [style.gridTemplateColumns]="getGridTemplate(field.optionColumns)">
                  <div class="opt-cell" *ngFor="let c of field.optionColumns">
                    {{ c.title }}
                  </div>
                </div>
              </nz-option>

              <!-- ASYNC OPTIONS -->
              <ng-container *ngIf="field.options$ | async as asyncOpts; else staticOptions">
                <nz-option *ngFor="let opt of asyncOpts" [nzLabel]="opt.label" [nzValue]="opt.value"
                  [nzTitle]="opt.searchText || opt.label" [nzCustomContent]="true">
                  <ng-container *ngIf="field.optionColumns?.length; else simpleOpt">
                    <div class="opt-row" [style.gridTemplateColumns]="getGridTemplate(field.optionColumns)">
                      <div class="opt-cell" *ngFor="let c of field.optionColumns">
                        {{ opt.meta?.[c.key] ?? '' }}
                      </div>
                    </div>
                  </ng-container>

                  <ng-template #simpleOpt>{{ opt.label }}</ng-template>
                </nz-option>
              </ng-container>

              <!-- STATIC OPTIONS -->
              <ng-template #staticOptions>
                <nz-option *ngFor="let opt of field.options || []" [nzLabel]="opt.label" [nzValue]="opt.value"
                  [nzTitle]="opt.searchText || opt.label">
                  {{ opt.label }}
                </nz-option>
              </ng-template>
            </nz-select>

            <div class="text-danger mt-1" *ngIf="hasError(field.key, 'required')">
              {{ field.label }} is required
            </div>
          </nz-form-control>
        </nz-form-item>

        <!-- DATE -->
        <nz-form-item *ngIf="field.type === 'date'">
          <nz-form-label [nzRequired]="field.required">
            {{ field.label }}
          </nz-form-label>

          <nz-form-control>
            <nz-date-picker style="width: 100%" [formControlName]="field.key" [nzDisabled]="!!field.disabled"
              [nzDisabledDate]="getDisabledDateFn(field.key)" [nzInputReadOnly]="true"></nz-date-picker>
          </nz-form-control>
        </nz-form-item>

        <!-- CHECKBOX -->
        <nz-form-item *ngIf="field.type === 'checkbox'">
          <nz-form-label [nzRequired]="field.required">
            {{ field.label }}
          </nz-form-label>

          <nz-form-control>
            <label nz-checkbox [formControlName]="field.key">
              {{ field.label }}
            </label>
          </nz-form-control>
        </nz-form-item>

        <!-- FILE -->
        <nz-form-item *ngIf="field.type === 'file'">
          <nz-form-label>{{ field.label }}</nz-form-label>

          <nz-form-control>
            <button nz-button nzType="default" type="button"
              [disabled]="isFileDisabled(field) || uploadingMap[field.key]" (click)="fileInput.click()">
              <i class="fa fa-upload me-1"></i>
              Bulk Import
            </button>

            <input #fileInput type="file" hidden [accept]="field.accept" (change)="onFileSelected(field.key, $event)" />

            <div *ngIf="uploadingMap[field.key]" class="mt-2">
              <nz-progress [nzPercent]="uploadProgressMap[field.key]" nzStatus="active" nzSize="small"></nz-progress>

              <small class="text-muted">
                Uploading... {{ uploadProgressMap[field.key] }}%
              </small>
            </div>

            <div class="text-muted mt-1" *ngIf="!uploadingMap[field.key]">
              Only CSV / Excel files allowed
            </div>
          </nz-form-control>
        </nz-form-item>
      </ng-container>
    </div>

    <div class="form-actions mt-3">
      <button nz-button nzType="primary" [disabled]="form.invalid">
        Save
      </button>
    </div>
  </form>
</nz-card>