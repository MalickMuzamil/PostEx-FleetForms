<!-- delivery-route-bulk-preview-component.html (UPDATED - show raw wrong value under the same column) -->

<div class="container-fluid mt-4">
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <!-- LEFT: Back + Proceed -->
                <div class="d-flex align-items-center gap-2">
                    <button class="btn btn-outline-secondary" routerLink="/delivery-route-binding">
                        ‚Üê Back
                    </button>

                    <button class="btn btn-success px-4" *ngIf="selectedValidCount >= 2"
                        [disabled]="isLoading || !canProceed" (click)="proceedBulkUpdate()">
                        <span *ngIf="bulkSaving" class="spinner-border spinner-border-sm me-2"></span>
                        {{ bulkSaving ? 'Processing...' : 'Proceed' }}
                    </button>
                </div>

                <!-- RIGHT: Title -->
                <h4 class="fw-bold mb-0 text-end">Delivery Route Bulk Preview</h4>
            </div>

            <nz-spin [nzSpinning]="isLoading" [nzTip]="loadingText">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 40px">
                                    <input type="checkbox" class="form-check-input" [ngModel]="checkAll"
                                        (ngModelChange)="onToggleAll($event)" [disabled]="isLoading" />
                                </th>
                                <th>#</th>
                                <th>Delivery Route</th>
                                <th>Branch</th>
                                <th>Sub Branch</th>
                                <th>Correct Description</th>
                                <th>Effective Date</th>
                                <th>Required Reports</th>
                                <th style="width: 140px">Action</th>
                            </tr>
                        </thead>

                        <tbody>
                            <ng-container *ngFor="let row of rows; let i = index; trackBy: trackByRow">
                                <tr [@rowAnim] [class.table-warning]="row.checked"
                                    [class.table-danger]="(row.errors?.length ?? 0) > 0">

                                    <!-- Checkbox -->
                                    <td>
                                        <input type="checkbox" class="form-check-input" [(ngModel)]="row.checked"
                                            (change)="onRowToggle(row, row.checked)"
                                            [disabled]="isLoading || !row.isValid" />
                                    </td>

                                    <!-- Row No -->
                                    <td>{{ row.rowNo }}</td>

                                    <!-- Delivery Route -->
                                    <td>
                                        <div class="cell-wrap">
                                            <select class="form-select form-select-sm"
                                                [formControl]="row.deliveryRouteControl"
                                                (change)="onRowRouteChange(row)" [disabled]="isLoading">
                                                <option value="">Any</option>
                                                <option *ngFor="let dr of deliveryRoutes" [value]="dr.DeliveryRouteID">
                                                    {{ dr.DeliveryRouteNo }} - {{ dr.DeliveryRouteDescription }}
                                                </option>
                                            </select>

                                            <div class="cell-msg">
                                                <div class="field-err"
                                                    *ngIf="(row.errors ?? []).includes('Delivery Route is required')">
                                                    <span class="dot"></span>
                                                    <strong>Delivery Route is required</strong>
                                                    <span class="file" *ngIf="row.rawDeliveryRoute">
                                                        Route ID: <strong>{{ row.rawDeliveryRoute }}</strong>
                                                    </span>
                                                </div>

                                                <div class="field-err warn"
                                                    *ngIf="(row.errors ?? []).includes('Delivery Route ID does not exist')">
                                                    <span class="dot"></span>
                                                    <span><strong>Route does not exist in DB</strong></span>
                                                    <span class="file" *ngIf="row.rawDeliveryRoute">
                                                        Route ID: <strong>{{ row.rawDeliveryRoute }}</strong>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </td>

                                    <!-- Branch -->
                                    <td>
                                        <div class="cell-wrap">
                                            <select class="form-select form-select-sm" [(ngModel)]="row.branchId"
                                                (ngModelChange)="onRowBranchChange(row)"
                                                [disabled]="isLoading || !row.deliveryRouteControl.value">
                                                <option [ngValue]="null">Select Branch</option>
                                                <option *ngFor="let b of row.routeBranches" [ngValue]="b.value">
                                                    {{ b.label }}
                                                </option>
                                            </select>

                                            <div class="cell-msg">
                                                <div class="field-err"
                                                    *ngIf="(row.errors ?? []).includes('Branch is required')">
                                                    <span class="dot"></span>
                                                    <span><strong>Branch is required</strong></span>
                                                    <span class="file" *ngIf="row.rawBranch">
                                                        Branch ID: <strong>{{ row.rawBranch }}</strong>
                                                    </span>
                                                </div>

                                                <div class="field-err warn"
                                                    *ngIf="(row.errors ?? []).includes('Branch does not belong to selected Route')">
                                                    <span class="dot"></span>
                                                    <strong>Branch does not match selected Route</strong>
                                                    <span class="file" *ngIf="row.rawBranch">
                                                        Branch ID: <strong>{{ row.rawBranch }}</strong>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </td>

                                    <!-- Sub Branch -->
                                    <td>
                                        <div class="cell-wrap">
                                            <select class="form-select form-select-sm" [(ngModel)]="row.subBranchId"
                                                [disabled]="isLoading || !row.branchId"
                                                (ngModelChange)="onRowSubBranchChange(row)">
                                                <option [ngValue]="null">Select Sub Branch</option>
                                                <option *ngFor="let sb of row.subBranches" [ngValue]="sb.SubBranchID">
                                                    {{ sb.SubBranchName }}
                                                </option>
                                            </select>

                                            <div class="cell-msg">
                                                <div class="field-err"
                                                    *ngIf="(row.errors ?? []).includes('Sub Branch is required')">
                                                    <span class="dot"></span>
                                                    <span><strong>Sub Branch is required</strong></span>
                                                    <span class="file" *ngIf="row.rawSubBranch">
                                                        Sub Branch ID: <strong>{{ row.rawSubBranch }}</strong>
                                                    </span>
                                                </div>

                                                <div class="field-err warn"
                                                    *ngIf="(row.errors ?? []).includes('Invalid SubBranchID (not found OR not mapped to BranchID)')">
                                                    <span class="dot"></span>
                                                    <strong>Sub Branch does not exist in DB / not mapped to
                                                        Branch</strong>
                                                    <span class="file" *ngIf="row.rawSubBranch">
                                                        Sub Branch ID: <strong>{{ row.rawSubBranch }}</strong>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </td>

                                    <!-- Correct Description -->
                                    <td>
                                        <div class="cell-wrap">
                                            <select class="form-select form-select-sm" [(ngModel)]="row.correctDescId"
                                                [disabled]="isLoading" (ngModelChange)="onRowDescChange(row)">

                                                <option [ngValue]="null">Select Description</option>
                                                <option *ngFor="let d of correctDescriptions" [ngValue]="d.id">
                                                    {{ d.text }}
                                                </option>
                                            </select>

                                            <div class="cell-msg">
                                                <!-- Required -->
                                                <div class="field-err"
                                                    *ngIf="(row.errors ?? []).includes('Description is required')">
                                                    <span class="dot"></span>
                                                    <span><strong>Description is required</strong></span>

                                                    <span class="file" *ngIf="row.rawCorrectDesc">
                                                        Description: <strong>{{ row.rawCorrectDesc }}</strong>
                                                    </span>
                                                </div>

                                                <!-- Not found -->
                                                <div class="field-err" *ngIf="(row.correctDescText?.trim() || '') && row.correctDescId == null
                                                        && !(row.errors ?? []).includes('Description is required')">

                                                    <span class="dot"></span>
                                                    <strong>Description does not exist in DB</strong>

                                                    <span class="file">
                                                        Value: <strong>{{ row.correctDescText }}</strong>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </td>

                                    <!-- Effective Date -->
                                    <td>
                                        <div class="cell-wrap">
                                            <nz-date-picker nzFormat="yyyy-MM-dd" nzSize="small"
                                                [formControl]="row.effectiveDateControl"
                                                [nzDisabledDate]="disablePastDates" [nzDisabled]="isLoading"
                                                (ngModelChange)="onRowDateChange(row)">
                                            </nz-date-picker>

                                            <div class="cell-msg">
                                                <div class="field-err"
                                                    *ngIf="(row.errors ?? []).includes('Invalid Date')">
                                                    <span class="dot"></span>
                                                    <strong>Invalid Effective Date</strong>
                                                    <span class="file" *ngIf="row.rawEffectiveDate">
                                                        Date: <strong>{{ row.rawEffectiveDate }}</strong>
                                                    </span>
                                                </div>

                                                <div class="field-err"
                                                    *ngIf="(row.errors ?? []).includes('Date must be a future date')">
                                                    <span class="dot"></span>
                                                    <strong>Effective Date must be a future date</strong>
                                                    <span class="file" *ngIf="row.rawEffectiveDate">
                                                        Date: <strong>{{ row.rawEffectiveDate }}</strong>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </td>

                                    <!-- Required Reports -->
                                    <td>
                                        <select class="form-select form-select-sm" [(ngModel)]="row.requiredReportsFlag"
                                            [disabled]="isLoading" (ngModelChange)="onRowFlagChange(row)">
                                            <option [ngValue]="1">Active</option>
                                            <option [ngValue]="0">Inactive</option>
                                        </select>
                                    </td>

                                    <!-- Action -->
                                    <td>
                                        <button class="btn btn-outline-primary btn-sm w-100"
                                            [disabled]="isLoading || !row.isValid || row.saving" (click)="saveRow(row)">
                                            <span *ngIf="row.saving"
                                                class="spinner-border spinner-border-sm me-1"></span>
                                            {{ row.saving ? 'Saving...' : 'Save' }}
                                        </button>

                                        <button class="btn btn-outline-danger btn-sm w-100 mt-2" type="button"
                                            [disabled]="isLoading" (click)="removeRow(i)">
                                            Remove
                                        </button>
                                    </td>

                                </tr>
                            </ng-container>
                        </tbody>


                    </table>
                </div>
            </nz-spin>
        </div>
    </div>
</div>